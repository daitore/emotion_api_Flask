# 感情判定ルールまとめ（judge_emotion）

このドキュメントは `judge_emotion(text)` が行う判定の全体ルールをまとめたもの。

---

## 1. 入力の前処理

- `text` を `_normalize(text)` で正規化したものを `t` として扱う  
  （例：全角/半角ゆれ、空白、表記ゆれの吸収など。内容は `_normalize` の実装に依存）

---

## 2. 辞書（キーワード）判定

### 2.1 感情カテゴリとキーワード
以下の辞書 `emotion_words` を使って判定する：

- 喜び：`["嬉しい","うれしい","やった","最高","助かった","できた","成功","よかった","ありがとう"]`
- 期待：`["楽しみ","期待","やってみたい","いけそう","挑戦","ワクワク","わくわく"]`
- 不安：`["不安","怖い","こわい","心配","やばい","焦る","眠れない"]`
- 怒り：`["ムカつく","むかつく","腹立つ","イライラ","最悪","ふざけるな","怒"]`
- 悲しみ：`["悲しい","かなしい","つらい","しんどい","泣","落ち込む","へこむ"]`
- 困惑：`["わからない","分からない","意味不明","困った","どうすれば","詰んだ","混乱"]`

---

## 3. スコア計算

### 3.1 初期化
- 各感情スコア `scores[感情]` を 0 で初期化する

### 3.2 強調語（boost）
- `boosters = ["超","めっちゃ","すごく","かなり","本当に","マジで"]`
- `t` に含まれる強調語の種類数を数え、最大2まで使う  
  - `boost_count = (含まれる強調語の数)`
  - `boost_bonus = min(boost_count, 2)`

### 3.3 記号ボーナス（辞書とは別の加点）
- `!` または `！` を含む場合
  - `scores["喜び"] += 1`
  - `scores["期待"] += 1`
- `?` または `？` を含む場合
  - `scores["困惑"] += 1`
  - `scores["不安"] += 1`

> 注意：これは「辞書ワードが無い文」でも点が入る可能性がある。

### 3.4 辞書ワードの加点ルール（メイン）
- 各感情カテゴリの各ワード `w` について、`t.find(w)` でヒットを探す
- ヒットした場合、基本加点は以下：

**加点値 `add`**
- `add = 2 + boost_bonus`

**否定語チェック（近い否定で減点）**
- `negations = ["ない","じゃない","ではない","なく","なかった","ません"]`
- ヒット位置から `window = t[idx : idx + len(w) + 6]` の範囲を取り、
  - `window` 内に否定語があれば `add -= 1`

**合計**
- `scores[emo] += add`

### 3.5 マイナス丸め
- `scores` の値がマイナスになった場合は 0 に戻す（見た目用）

---

## 4. 辞書ワード未ヒット時の扱い（中立/記号判定）

### 4.1 辞書ワードヒット判定
- 辞書ワードが1回でもヒットしたかを `word_hit` で管理する  
  - 1つでもヒットしたら `word_hit = True`

### 4.2 辞書ワードが0回の場合
`word_hit == False` の場合は、まず「記号だけ判定」を試す。

#### 記号カウント
- `ex = count("!") + count("！")`
- `qu = count("?") + count("？")`

#### 記号ルール（優先順）
1) `!?` / `！？` / `?!` / `？！` を含む  
→ **困惑**

2) `ex >= 2` かつ `qu == 0`  
→ **期待**（好みで喜びに変更OK）

3) `qu >= 2` かつ `ex == 0`  
→ **困惑**

4) `ex >= 2` かつ `qu >= 2`  
→ **困惑**

5) それ以外  
→ **中立**

> 目的：  
> - `今日は火曜日です！`（!が1個程度）で誤判定しにくくする  
> - `！？！？` のような記号表現は拾う

---

## 5. 辞書ヒットありの場合の最終判定（主/副）

### 5.1 スコアの並べ替え
- `scores.items()` をスコア降順でソートし、上位2つを見る  
  - `top1 = 1位`
  - `top2 = 2位`

### 5.2 主感情
- 主は必ず `top1` の感情

### 5.3 副感情（条件つき）
- `top2` のスコアが一定以上なら副として採用する  
  - 例：`top2[1] >= 2` の場合、副を出す

### 5.4 出力ラベル
- 副あり：`"主：{top1} / 副：{top2}"`
- 副なし：`"主：{top1}"`

---

## 6. APIレスポンス用（推奨設計）

表示とCSSの安全性のため、返すデータは分けるのが安全：

- `label`：表示用（例：`主：喜び / 副：不安`）
- `main`：CSS用（主感情のみ、例：`喜び`）
- `sub`：副感情（例：`不安` or null）
- `scores`：スコア辞書

例：
```json
{
  "label": "主：喜び / 副：不安",
  "main": "喜び",
  "sub": "不安",
  "scores": { "喜び": 5, "不安": 4, ... }
}


## 公開URL
https://emotion-api-flask.onrender.com
